<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 600px;
      margin: auto;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .file-list {
      list-style-type: none;
      padding: 0;
    }
    .file-item {
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 10px;
    }
    .file-item a {
      color: black;
      text-decoration: none;
      font-size: 18px;
    }
    .file-item a:hover {
      text-decoration: underline;
    }
    .upload-date {
      color: gray;
      font-size: 14px;
      margin-top: 5px;
    }
    .no-files {
      text-align: center;
      color: gray;
      margin: 20px 0;
    }
    .upload-button {
      display: block;
      margin: 30px auto;
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      text-align: center;
      text-decoration: none;
      font-size: 16px;
      border-radius: 5px;
    }
    .upload-button:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>Your Files</h1>
  <ul id="fileList" class="file-list"></ul>
  <p id="noFilesMessage" class="no-files" style="display: none;">You have no files.</p>
  <a href="/upload.html" class="upload-button">Upload New File</a>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
<script src="/js/firebase-config.js"></script>

<script>
  // Firebase is already initialized in firebase-config.js
  const auth = firebaseAuth;
  const db = firebaseDB;
  const storage = firebaseStorage;

  const fileList = document.getElementById('fileList');
  const noFilesMessage = document.getElementById('noFilesMessage');

  async function loadFiles() {
    const user = auth.currentUser;
    if (!user) {
      alert('You need to log in to view your files.');
      return;
    }

    const userID = user.uid;

    // try {
    // const userDoc = await db.collection('users').doc(userID).get();

    // if (!userDoc.exists || !userDoc.data().files || userDoc.data().files.length === 0) {
    // // No file
    // noFilesMessage.style.display = 'block';
    // return;
    // }

    // const files = userDoc.data().files;
    // files.forEach(file => {
    // console.log('Processing file:', file);
    // const listItem = document.createElement('li');
    // listItem.className = 'file-item';

    // if (file.analysisAvailable || file.recommendAvailable) {
    // console.log(file.path, file.analysisAvailable, file.recommendAvailable);
    // const fileLink = document.createElement('a');
    // fileLink.href = `/${file.fileID}/analysis`; // Link to file analysis page
    // fileLink.textContent = file.path.split('/').pop().split('-').slice(0, -1).join('-'); // Remove timestamp from filename
    // listItem.appendChild(fileLink);
    // } else {
    // console.log(file.path, file.analysisAvailable, file.recommendAvailable);
    // const fileNameText = document.createElement('span');
    // fileNameText.textContent = file.path.split('/').pop().split('-').slice(0, -1).join('-'); // Remove timestamp from filename
    // listItem.appendChild(fileNameText);
    // }

    // const uploadDate = document.createElement('p');
    // uploadDate.className = 'upload-date';
    // uploadDate.textContent = `Uploaded: ${new Date(file.uploadedDate).toLocaleString()}`;
    // listItem.appendChild(uploadDate);

    // fileList.appendChild(listItem);
    // });
    // } catch (err) {
    // console.error('Error fetching files:', err);
    // alert('Failed to load files. Please try again later.');
    // }
  
    const userDoc = await db.collection('users').doc(userID).get();
    if (!userDoc.exists || !userDoc.data().files || userDoc.data().files.length === 0) {
      // No files
      noFilesMessage.style.display = 'block';
      return;
    }

    const fileIDs = userDoc.data().files; // List of fileIDs

    for (const fileID of fileIDs) {
      try {
        const fileDoc = await db.collection('file').doc(fileID).get();

        if (!fileDoc.exists) {
          console.warn(`File with ID ${fileID} does not exist in the "file" collection.`);
          continue;
        }

        const file = fileDoc.data();
        console.log('Processing file:', file);

        const listItem = document.createElement('li');
        listItem.className = 'file-item';

        if (file.analysisAvailable) {
          const fileLink = document.createElement('a');
          fileLink.href = `/${fileID}/analysis`;
          fileLink.textContent = file.filename;
          listItem.appendChild(fileLink);
        } else {
          const fileNameText = document.createElement('span');
          fileNameText.textContent = file.filename;
          listItem.appendChild(fileNameText);
        }

        const uploadDate = document.createElement('p');
        uploadDate.className = 'upload-date';
        uploadDate.textContent = `Uploaded: ${new Date(file.uploadedDate).toLocaleString()}`;
        listItem.appendChild(uploadDate);

        fileList.appendChild(listItem);
      } catch (err) {
        console.error(`Error fetching file details for fileID ${fileID}:`, err);
      }
    }
  }

  auth.onAuthStateChanged(user => {
    if (user) {
      loadFiles();
    } else {
      alert('Please log in to view your files.');
      window.location.href = '/login.html';
    }
  });
</script>

</body>
</html>